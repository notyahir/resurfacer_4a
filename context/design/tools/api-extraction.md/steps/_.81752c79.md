---
timestamp: 'Mon Nov 03 2025 18:15:48 GMT-0500 (Eastern Standard Time)'
parent: '[[../20251103_181548.ec826e0b.md]]'
content_id: 81752c79efb106cab1f0ae2e85ca322947a6cd351a64e169256a23a4c3199a53
---

# API Specification

This document outlines the HTTP API for the application, derived from its five core concepts. The API enables interaction with user platform links, cached library data, track scoring, swipe sessions, and playlist health analysis.

## General Conventions

* **Base URL**: All endpoint paths are prefixed with `/api`.
* **Authentication**: It is assumed that all endpoints require a valid user context (e.g., via a JWT `Authorization` header), although this is not explicitly detailed in the individual endpoint descriptions. The `userId` in request bodies should match the authenticated user.
* **Data Format**: All request and response bodies are in `application/json` format.
* **ID Types**: All identifiers (e.g., `userId`, `linkId`, `trackId`, `sessionId`) are represented as strings.
* **Error Responses**: Errors are returned with an appropriate HTTP status code (e.g., 400, 404) and a consistent JSON body:
  ```json
  {
    "error": "A descriptive error message."
  }
  ```

***

## 1. PlatformLink API

**Base Path**: `/api/platformlink`

Provides authenticated access to streaming platforms and serves as a secure gateway for other concepts to interact with platform data.

### POST /link

Creates a new link to a streaming platform for a user.

* **Request Body**:

| Field      | Type   | Required | Description                                     |
| :--------- | :----- | :------- | :---------------------------------------------- |
| `userId`   | string | Yes      | The ID of the user creating the link.           |
| `platform` | string | Yes      | The name of the platform (e.g., "spotify"). |

* **Success Response (200 OK)**:
  ```json
  {
    "linkId": "link:1a2b3c4d"
  }
  ```
* **Error Responses**:
  * `400 Bad Request`: If the platform is not supported or a link already exists for the user and platform.

### POST /refresh

Refreshes the access token for an existing platform link.

* **Request Body**:

| Field    | Type   | Required | Description                              |
| :------- | :----- | :------- | :--------------------------------------- |
| `linkId` | string | Yes      | The ID of the link to refresh the token for. |

* **Success Response (200 OK)**:
  ```json
  {
    "newExpiration": 1678886400000
  }
  ```
* **Error Responses**:
  * `404 Not Found`: If the specified `linkId` does not exist.

### POST /revoke

Revokes and deletes a user's link to a platform.

* **Request Body**:

| Field    | Type   | Required | Description                      |
| :------- | :----- | :------- | :------------------------------- |
| `linkId` | string | Yes      | The ID of the link to be revoked. |

* **Success Response (200 OK)**:
  ```json
  {
    "removed": true
  }
  ```
* **Error Responses**:
  * `404 Not Found`: If the specified `linkId` does not exist.

### POST /can

Checks if a link is active (token not expired) and has a specific capability.

* **Request Body**:

| Field        | Type   | Required | Description                               |
| :----------- | :----- | :------- | :---------------------------------------- |
| `linkId`     | string | Yes      | The ID of the link to check.              |
| `capability` | string | Yes      | The name of the capability to verify. |

* **Success Response (200 OK)**:
  ```json
  {
    "ok": true
  }
  ```

### GET /links

Lists all platform links associated with a given user.

* **Query Parameters**:

| Parameter | Type   | Required | Description                            |
| :-------- | :----- | :------- | :------------------------------------- |
| `userId`  | string | Yes      | The ID of the user to list links for. |

* **Success Response (200 OK)**:
  ```json
  {
    "links": [
      {
        "linkId": "link:1a2b3c4d",
        "platform": "spotify",
        "tokenExpiration": 1678886400000
      }
    ]
  }
  ```
* **Error Responses**:
  * `400 Bad Request`: If `userId` is not provided.

### POST /sync-library

Accepts a full library payload from a platform and syncs it into the `LibraryCache` concept. This is a high-level integration endpoint.

* **Request Body**:

| Field     | Type   | Required | Description                                         |
| :-------- | :----- | :------- | :-------------------------------------------------- |
| `linkId`  | string | Yes      | The ID of the link providing the data.              |
| `payload` | object | Yes      | A structured object containing the user's library data. See below. |

* **Payload Structure**:
  ```json
  {
    "userId": "user:Alice",
    "tracks": [
      { "trackId": "t1", "title": "Song A", "artist": "Artist X", "available": true, "tempo": 120 }
    ],
    "likes": [{ "trackId": "t1", "addedAt": 1678880000000 }],
    "plays": [{ "trackId": "t1", "lastPlayedAt": 1678881000000 }],
    "playlists": [
      { "playlistId": "p1", "entries": [{ "idx": 0, "trackId": "t1" }], "updatedAt": 1678882000000 }
    ]
  }
  ```

* **Success Response (200 OK)**:
  ```json
  {
    "synced": true
  }
  ```

* **Error Responses**:
  * `400 Bad Request`: If the payload is invalid, the token is expired, or the payload's `userId` does not match the link's owner.
  * `404 Not Found`: If the `linkId` does not exist.

### POST /bootstrap-track-scoring

A convenience endpoint to ingest stats from `LibraryCache` into `TrackScoring` and generate an initial score preview for a user.

* **Request Body**:

| Field    | Type   | Required | Description                               |
| :------- | :----- | :------- | :---------------------------------------- |
| `userId` | string | Yes      | The user for whom to bootstrap scores.    |
| `size`   | number | No       | The number of tracks for the preview (default: 50). |

* **Success Response (200 OK)**:
  ```json
  {
    "ingested": 150,
    "ensuredWeights": true,
    "previewCount": 50,
    "source": "bootstrap"
  }
  ```
* **Error Responses**:
  * `400 Bad Request`: If `userId` is missing or no library cache data is found.

***

## 2. LibraryCache API

**Base Path**: `/api/library-cache`

Manages a local, queryable snapshot of a userâ€™s tracks, likes, plays, and playlists.

### POST /sync

Performs a full replacement sync for a user's library data. It updates track metadata and replaces the user's likes, plays, and playlists with the provided data.

* **Request Body**: `SyncArgs` object.

| Field       | Type    | Required | Description                                    |
| :---------- | :------ | :------- | :--------------------------------------------- |
| `userId`    | string  | Yes      | The user whose library is being synced.        |
| `tracks`    | array   | Yes      | Array of track metadata objects.               |
| `likes`     | array   | Yes      | Array of liked track objects.                  |
| `plays`     | array   | Yes      | Array of play history objects.                 |
| `playlists` | array   | Yes      | Array of playlist objects.                     |

* **Example Request Body**:
  ```json
  {
    "userId": "user:Alice",
    "tracks": [
      { "trackId": "t1", "title": "Song A", "artist": "Artist X", "available": true }
    ],
    "likes": [{ "trackId": "t1", "addedAt": 1678880000000 }],
    "plays": [{ "trackId": "t1", "lastPlayedAt": 1678881000000 }],
    "playlists": [
      { "playlistId": "p1", "entries": [{ "idx": 0, "trackId": "t1" }], "updatedAt": 1678882000000 }
    ]
  }
  ```
* **Success Response (200 OK)**:
  ```json
  {}
  ```

### POST /ingest

Alias for the `/sync` endpoint. It accepts the same request body and produces the same effects.

### GET /liked-tracks

Returns a list of track IDs for a user's liked tracks, sorted by most recently added.

* **Query Parameters**:

| Parameter | Type   | Required | Description                      |
| :-------- | :----- | :------- | :------------------------------- |
| `userId`  | string | Yes      | The user to retrieve liked tracks for. |

* **Success Response (200 OK)**:
  ```json
  {
    "trackIds": ["track:t3", "track:t1", "track:t2"]
  }
  ```

### GET /playlist

Returns an ordered list of track IDs for a given playlist.

* **Query Parameters**:

| Parameter    | Type   | Required | Description                           |
| :----------- | :----- | :------- | :------------------------------------ |
| `playlistId` | string | Yes      | The ID of the playlist to retrieve. |

* **Success Response (200 OK)**:
  ```json
  {
    "entries": ["track:t1", "track:t4", "track:t5"]
  }
  ```
  *Note: Returns `{"entries": []}` if the playlist is not found.*

***

## 3. TrackScoring API

**Base Path**: `/api/track-scoring`

Computes a "staleness" score for tracks and manages user-driven boosts and snoozes.

### POST /update-weights

Updates the scoring weights for a user.

* **Request Body**:

| Field           | Type   | Required | Description                           |
| :-------------- | :----- | :------- | :------------------------------------ |
| `userId`        | string | Yes      | The user to update weights for.       |
| `lastPlayedW`   | number | Yes      | Weight for last played timestamp.     |
| `likedWhenW`    | number | Yes      | Weight for liked timestamp.           |
| `timesSkippedW` | number | Yes      | Weight for number of skips.           |

* **Success Response (200 OK)**: `{}`

### POST /update-stats

Updates the playback statistics for a single track for a user.

* **Request Body**:

| Field          | Type   | Required | Description                             |
| :------------- | :----- | :------- | :-------------------------------------- |
| `userId`       | string | Yes      | The user associated with the stats.     |
| `trackId`      | string | Yes      | The track associated with the stats.    |
| `lastPlayedAt` | number | Yes      | Unix timestamp of the last play.        |
| `likedAt`      | number | Yes      | Unix timestamp when the track was liked. |
| `timesSkipped` | number | Yes      | Total number of skips for the track.    |

* **Success Response (200 OK)**: `{}`

### POST /score

Computes and stores a staleness score for a given track.

* **Request Body**:

| Field     | Type   | Required | Description           |
| :-------- | :----- | :------- | :-------------------- |
| `userId`  | string | Yes      | The user context.     |
| `trackId` | string | Yes      | The track to score. |

* **Success Response (200 OK)**:
  ```json
  {
    "score": 85
  }
  ```
* **Error Responses**:
  * `404 Not Found`: If weights or stats do not exist for the user/track.

### GET /preview

Returns a list of track IDs for a user, sorted by their staleness score in descending order.

* **Query Parameters**:

| Parameter | Type   | Required | Description                                       |
| :-------- | :----- | :------- | :------------------------------------------------ |
| `userId`  | string | Yes      | The user to retrieve the preview for.             |
| `size`    | number | No       | The number of tracks to return (default: 50, max: 100). |

* **Success Response (200 OK)**:
  ```json
  {
    "trackIds": ["track:t10", "track:t5", "..."],
    "tracks": [
      { "trackId": "track:t10", "score": 95, "lastPlayedAt": 1670000000000 },
      { "trackId": "track:t5", "score": 92, "lastPlayedAt": 1671000000000 },
      "..."
    ],
    "source": "scores"
  }
  ```

### POST /keep

Increases a track's boost, making it more likely to appear in previews.

* **Request Body**:

| Field     | Type   | Required | Description                 |
| :-------- | :----- | :------- | :-------------------------- |
| `userId`  | string | Yes      | The user boosting the track. |
| `trackId` | string | Yes      | The track to boost.         |

* **Success Response (200 OK)**: `{}`

### POST /snooze

Snoozes a track, preventing it from appearing in previews for a period of time.

* **Request Body**:

| Field     | Type   | Required | Description                           |
| :-------- | :----- | :------- | :------------------------------------ |
| `userId`  | string | Yes      | The user snoozing the track.          |
| `trackId` | string | Yes      | The track to snooze.                  |
| `until`   | number | No       | Duration in ms (default: 7 days). |

* **Success Response (200 OK)**: `{}`

***

## 4. SwipeSessions API

**Base Path**: `/api/swipe-sessions`

Manages interactive "Memory Card" style swipe sessions for users to rediscover their music.

### POST /start

Starts a new swipe session for a user with a given queue of tracks.

* **Request Body**:

| Field         | Type     | Required | Description                                  |
| :------------ | :------- | :------- | :------------------------------------------- |
| `userId`      | string   | Yes      | The user starting the session.               |
| `queueTracks` | string\[] | Yes      | An array of track IDs to include in the session. |
| `size`        | number   | No       | Truncates `queueTracks` to this length.      |

* **Success Response (200 OK)**:
  ```json
  {
    "sessionId": "session:xyz789"
  }
  ```

### POST /next

Retrieves the next track in the session's queue and advances the cursor.

* **Request Body**:

| Field       | Type   | Required | Description                    |
| :---------- | :----- | :------- | :----------------------------- |
| `sessionId` | string | Yes      | The ID of the active session. |

* **Success Response (200 OK)**:
  * When a track is available:
    ```json
    {
      "trackId": "track:t8"
    }
    ```
  * When the queue is finished:
    ```json
    {
      "trackId": "-1"
    }
    ```
* **Error Responses**:
  * `404 Not Found`: If the `sessionId` is invalid.

### POST /decide-keep

Records a 'keep' decision for the current track in a session.

* **Request Body**:

| Field       | Type   | Required | Description                           |
| :---------- | :----- | :------- | :------------------------------------ |
| `sessionId` | string | Yes      | The ID of the active session.         |
| `trackId`   | string | Yes      | The ID of the track being decided on. |

* **Success Response (200 OK)**: `{"decisionId": "dec:abc123"}`

### POST /decide-snooze

Records a 'snooze' decision for the current track in a session.

* **Request Body**:

| Field       | Type   | Required | Description                                      |
| :---------- | :----- | :------- | :----------------------------------------------- |
| `sessionId` | string | Yes      | The ID of the active session.                    |
| `trackId`   | string | Yes      | The ID of the track being decided on.            |
| `untilAt`   | number | No       | Unix timestamp to snooze until (for `arg`). |

* **Success Response (200 OK)**: `{"decisionId": "dec:def456"}`

### POST /decide-add-to-playlist

Records a decision to add the current track to an existing playlist.

* **Request Body**:

| Field        | Type   | Required | Description                           |
| :----------- | :----- | :------- | :------------------------------------ |
| `sessionId`  | string | Yes      | The ID of the active session.         |
| `trackId`    | string | Yes      | The ID of the track being decided on. |
| `playlistId` | string | Yes      | The ID of the target playlist.        |

* **Success Response (200 OK)**: `{"decisionId": "dec:ghi789"}`

### POST /decide-create-playlist

Records a decision to create a new playlist with the current track.

* **Request Body**:

| Field           | Type   | Required | Description                              |
| :-------------- | :----- | :------- | :--------------------------------------- |
| `sessionId`     | string | Yes      | The ID of the active session.            |
| `trackId`       | string | Yes      | The ID of the track being decided on.    |
| `playlistTitle` | string | Yes      | The title for the new playlist.          |

* **Success Response (200 OK)**: `{"decisionId": "dec:jkl012"}`

### POST /end

Ends and deletes a session.

* **Request Body**:

| Field       | Type   | Required | Description                    |
| :---------- | :----- | :------- | :----------------------------- |
| `sessionId` | string | Yes      | The ID of the session to end. |

* **Success Response (200 OK)**: `{"ended": true}`

***

## 5. PlaylistHealth API

**Base Path**: `/api/playlist-health`

Analyzes playlist snapshots to find duplicates, unavailable tracks, and other issues.

### POST /snapshot

Creates and stores a snapshot of a playlist's current track list.

* **Request Body**:

| Field        | Type     | Required | Description                              |
| :----------- | :------- | :------- | :--------------------------------------- |
| `playlistId` | string   | Yes      | The ID of the playlist being snapshotted. |
| `userId`     | string   | Yes      | The ID of the playlist owner.            |
| `trackIds`   | string\[] | Yes      | An ordered array of track IDs.           |

* **Success Response (200 OK)**: `{"snapshotId": "snap:pqr345"}`

### POST /analyze

Analyzes a given snapshot to find issues and generates a health report.

* **Request Body**:

| Field        | Type   | Required | Description                       |
| :----------- | :----- | :------- | :-------------------------------- |
| `playlistId` | string | Yes      | The ID of the playlist.           |
| `snapshotId` | string | Yes      | The ID of the snapshot to analyze. |

* **Success Response (200 OK)**: `{"reportId": "rep:stu678"}`
* **Error Responses**:
  * `404 Not Found`: If the snapshot for the given playlist does not exist.

### GET /report/:reportId

Retrieves the results of a previously generated playlist health report.

* **URL Parameters**:

| Parameter  | Type   | Description                       |
| :--------- | :----- | :-------------------------------- |
| `reportId` | string | The ID of the report to retrieve. |

* **Success Response (200 OK)**:
  ```json
  {
    "playlistId": "playlist:abc",
    "snapshotId": "snap:pqr345",
    "findings": [
      { "idx": 5, "trackId": "track:t2", "kind": "Duplicate" },
      { "idx": 8, "trackId": null, "kind": "Unavailable" },
      { "idx": 6, "trackId": "track:t7", "kind": "Outlier" }
    ]
  }
  ```
* **Error Responses**:
  * `404 Not Found`: If the `reportId` does not exist.
