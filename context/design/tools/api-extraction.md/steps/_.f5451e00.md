---
timestamp: 'Mon Nov 03 2025 21:01:00 GMT-0500 (Eastern Standard Time)'
parent: '[[../20251103_210100.a6a0b744.md]]'
content_id: f5451e004089398bd7d052d9d69b65b1202b9ac957beecd9e89dcdd0d205375b
---

# API Specification

This API provides programmatic access to manage streaming platform connections, user music libraries, track scoring, swipe-based review sessions, and playlist health analysis.

## General Principles

### Authentication

All API endpoints require authentication. The user's identity is assumed to be available from the request context (e.g., via a session token or JWT bearer token). For simplicity, `userId` is often passed explicitly in request bodies or query parameters.

### Data Format

All request and response bodies are in JSON format.

### Error Handling

When an API call fails due to invalid input or a state violation (e.g., resource not found), it will respond with a `4xx` HTTP status code. The response body will contain an error object.

**Example Error Response:**

* **Code:** `400 Bad Request` or `404 Not Found`
* **Body:**
  ```json
  {
    "error": "A descriptive error message."
  }
  ```

***

## PlatformLink

Provides authenticated access to streaming platforms, managing OAuth flows and tokens securely.

### Start Spotify Authentication

Initiates the OAuth 2.0 PKCE flow for Spotify, returning a URL to which the user should be redirected.

`POST /platform-link/auth/start`

**Request Body:**

```json
{
  "userId": "user:123",
  "platform": "spotify",
  "scopes": ["user-library-read", "user-top-read"],
  "redirectUri": "https://yourapp.com/callback"
}
```

**Success Response (200 OK):**

```json
{
  "authorizeUrl": "https://accounts.spotify.com/authorize?client_id=...",
  "state": "a_long_random_string_for_verification",
  "expiresAt": 1672531800000
}
```

### Complete Spotify Authentication

Exchanges the authorization code received from Spotify for an access token and refresh token, creating or updating a platform link for the user.

`POST /platform-link/auth/complete`

**Request Body:**

```json
{
  "state": "the_same_state_string_from_start",
  "code": "the_authorization_code_from_spotify_redirect"
}
```

**Success Response (200 OK):**

```json
{
  "linkId": "link:xyz789",
  "platform": "spotify",
  "tokenExpiration": 1672535400000,
  "scopes": ["user-library-read", "user-top-read"]
}
```

### Refresh an Access Token

Uses a refresh token to obtain a new access token for an existing link.

`POST /platform-link/{linkId}/refresh`

**Success Response (200 OK):**

```json
{
  "newExpiration": 1672539000000
}
```

**Error Response (404 Not Found):**

```json
{
  "error": "Link with id 'link:xyz789' not found."
}
```

### Revoke a Platform Link

Deletes a platform link and all associated credentials and capabilities.

`DELETE /platform-link/{linkId}`

**Success Response (200 OK):**

```json
{
  "removed": true
}
```

### List a User's Links

Retrieves all active platform links for a given user.

`GET /platform-link/links?userId={userId}`

**Success Response (200 OK):**

```json
{
  "links": [
    {
      "linkId": "link:xyz789",
      "platform": "spotify",
      "tokenExpiration": 1672539000000
    }
  ]
}
```

***

## LibraryCache

Manages a local snapshot of a user's music library, including tracks, likes, plays, and playlists.

### Sync User Library

Performs a full replacement sync of a user's library data. This is a bulk operation that updates tracks globally and replaces user-specific data like likes, plays, and playlists.

`POST /library-cache/sync`

**Request Body:**

```json
{
  "userId": "user:123",
  "tracks": [
    {
      "trackId": "spotify:track:123",
      "title": "Song Title",
      "artist": "Artist Name",
      "available": true,
      "tempo": 120.5,
      "energy": 0.8,
      "valence": 0.6
    }
  ],
  "likes": [
    {
      "trackId": "spotify:track:123",
      "addedAt": 1672531200000
    }
  ],
  "plays": [
    {
      "trackId": "spotify:track:123",
      "lastPlayedAt": 1672617600000
    }
  ],
  "playlists": [
    {
      "playlistId": "spotify:playlist:abc",
      "entries": [
        { "idx": 0, "trackId": "spotify:track:123" },
        { "idx": 1, "trackId": "spotify:track:456" }
      ],
      "updatedAt": 1672617600000
    }
  ]
}
```

**Success Response (200 OK):**

```json
{}
```

### Get Liked Tracks

Retrieves a list of track IDs for a user's liked tracks, sorted by most recently added.

`GET /library-cache/liked?userId={userId}`

**Success Response (200 OK):**

```json
{
  "trackIds": [
    "spotify:track:456",
    "spotify:track:123"
  ]
}
```

### Get Playlist Tracks

Retrieves an ordered list of track IDs for a given playlist.

`GET /library-cache/playlist/{playlistId}`

**Success Response (200 OK):**

```json
{
  "entries": [
    "spotify:track:123",
    "spotify:track:456"
  ]
}
```

***

## TrackScoring

Computes a "staleness" score for tracks in a user's library and manages user preferences for resurfacing them.

### Update Scoring Weights

Sets or updates the weights used to calculate track scores for a specific user.

`PUT /track-scoring/weights`

**Request Body:**

```json
{
  "userId": "user:123",
  "lastPlayedW": 0.6,
  "likedWhenW": 0.3,
  "timesSkippedW": 15
}
```

**Success Response (200 OK):**

```json
{}
```

### Ingest Stats from LibraryCache

Populates the initial `Stats` for a user by pulling data from their cached library. This is a crucial step to bootstrap the scoring system.

`POST /track-scoring/ingest-from-library`

**Request Body:**

```json
{
  "userId": "user:123"
}
```

**Success Response (200 OK):**

```json
{
  "ingested": 250,
  "ensuredWeights": true
}
```

### Preview Recommended Tracks

Returns a list of track IDs sorted by their staleness score, representing candidates for resurfacing. This endpoint can bootstrap scoring if scores don't exist yet.

`GET /track-scoring/preview?userId={userId}&size={size}`

**Query Parameters:**

* `userId` (string, required): The ID of the user.
* `size` (number, optional, default: 50): The number of tracks to return.

**Success Response (200 OK):**

```json
{
  "trackIds": [
    "spotify:track:old_song_1",
    "spotify:track:old_song_2"
  ],
  "tracks": [
    {
      "trackId": "spotify:track:old_song_1",
      "score": 95,
      "lastPlayedAt": 1577836800000
    },
    {
      "trackId": "spotify:track:old_song_2",
      "score": 92,
      "lastPlayedAt": 1580515200000
    }
  ],
  "source": "bootstrap"
}
```

### Keep a Track

Records a user's decision to "keep" a suggested track, applying a positive boost to its score.

`POST /track-scoring/keep`

**Request Body:**

```json
{
  "userId": "user:123",
  "trackId": "spotify:track:old_song_1"
}
```

**Success Response (200 OK):**

```json
{}
```

### Snooze a Track

Records a user's decision to "snooze" a suggested track, temporarily suppressing it from recommendations.

`POST /track-scoring/snooze`

**Request Body:**

```json
{
  "userId": "user:123",
  "trackId": "spotify:track:old_song_2",
  "until": 86400000
}
```

**Success Response (200 OK):**

```json
{}
```

***

## SwipeSessions

Manages short, interactive sessions for users to review their tracks and make decisions.

### Start a Session

Creates a new swipe session with a specified queue of tracks.

`POST /swipe-sessions/start`

**Request Body:**

```json
{
  "userId": "user:123",
  "queueTracks": ["spotify:track:abc", "spotify:track:def", "spotify:track:ghi"],
  "size": 3
}
```

**Success Response (200 OK):**

```json
{
  "sessionId": "session:abcdef"
}
```

### Get Next Track

Retrieves the next track in the session queue and advances the cursor.

`POST /swipe-sessions/{sessionId}/next`

**Success Response (200 OK):**

```json
{
  "trackId": "spotify:track:def"
}
```

*Note: Returns `{ "trackId": "-1" }` when the queue is finished.*

### Decide on a Track

Records a user's decision for the currently presented track.

`POST /swipe-sessions/{sessionId}/decide/{decisionType}`

**Decision Types:** `keep`, `snooze`, `add-to-playlist`, `create-playlist`

**Example: Keep a track** (`POST /swipe-sessions/{sessionId}/decide/keep`)
**Request Body:**

```json
{
  "trackId": "spotify:track:def"
}
```

**Example: Add to Playlist** (`POST /swipe-sessions/{sessionId}/decide/add-to-playlist`)
**Request Body:**

```json
{
  "trackId": "spotify:track:def",
  "playlistId": "spotify:playlist:xyz"
}
```

**Success Response (200 OK) for all decision types:**

```json
{
  "decisionId": "decision:12345"
}
```

### End a Session

Ends and deletes a swipe session.

`DELETE /swipe-sessions/{sessionId}`

**Success Response (200 OK):**

```json
{
  "ended": true
}
```

***

## PlaylistHealth

Analyzes playlists for issues like duplicate tracks, unavailable songs, and outliers.

### Create a Playlist Snapshot

Stores a snapshot of a playlist's current track list for later analysis.

`POST /playlist-health/snapshot`

**Request Body:**

```json
{
  "playlistId": "spotify:playlist:xyz",
  "userId": "user:123",
  "trackIds": ["spotify:track:a", "spotify:track:b", "spotify:track:a"]
}
```

**Success Response (200 OK):**

```json
{
  "snapshotId": "snap:qwerty"
}
```

### Analyze a Snapshot

Runs the analysis on a stored snapshot and generates a report.

`POST /playlist-health/analyze`

**Request Body:**

```json
{
  "playlistId": "spotify:playlist:xyz",
  "snapshotId": "snap:qwerty"
}
```

**Success Response (200 OK):**

```json
{
  "reportId": "report:asdfg"
}
```

### Get an Analysis Report

Retrieves the findings from a previously generated report.

`GET /playlist-health/report/{reportId}`

**Success Response (200 OK):**

```json
{
  "playlistId": "spotify:playlist:xyz",
  "snapshotId": "snap:qwerty",
  "findings": [
    {
      "idx": 2,
      "trackId": "spotify:track:a",
      "kind": "Duplicate"
    }
  ]
}
```
